<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "lib/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h2">
        <a href="#log">log</a>
      </div>

      <div class="heading h2">
        <a href="#patch">patch</a>
      </div>

      <div class="heading h2">
        <a href="#report">report</a>
      </div>

      <div class="heading h2">
        <a href="#clear">clear</a>
      </div>

      <div class="heading h2">
        <a href="#build">build</a>
      </div>

      <div class="heading h2">
        <a href="#pushdata">pushData</a>
      </div>

      <div class="heading h2">
        <a href="#injectdata">injectData</a>
      </div>

      <div class="heading h2">
        <a href="#writeclient">writeClient</a>
      </div>

      <div class="heading h2">
        <a href="#readfilepromise">readFilePromise</a>
      </div>

      <div class="heading h2">
        <a href="#tree-fn">tree fn</a>
      </div>

      <div class="heading h2">
        <a href="#render">render</a>
      </div>

      <div class="heading h2">
        <a href="#exports">exports</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">import</span> vow <span class="hljs-keyword">from</span> <span class="hljs-string">'vow'</span>
<span class="hljs-keyword">import</span> wrap <span class="hljs-keyword">from</span> <span class="hljs-string">'wrap-fn'</span>
<span class="hljs-keyword">import</span> debug <span class="hljs-keyword">from</span> <span class="hljs-string">'debug'</span>
<span class="hljs-keyword">import</span> {
  sep,
  parse,
  join
} <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> {
  readdir,
  readFile
} <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>
<span class="hljs-keyword">import</span> transform <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash.transform'</span>
<span class="hljs-keyword">import</span> set <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash.set'</span>
<span class="hljs-keyword">import</span> stripAnsi <span class="hljs-keyword">from</span> <span class="hljs-string">'strip-ansi'</span>
<span class="hljs-keyword">import</span> util <span class="hljs-keyword">from</span> <span class="hljs-string">'util'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>used for debug messages</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> dbg = debug(<span class="hljs-string">'metalsmith-debug-ui'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>stores cloned data &amp; log until written to client</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> data = {
  <span class="hljs-attr">log</span>: [],
  <span class="hljs-attr">plugins</span>: []
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>whether client html, styles &amp; js has already been written to build dir</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">let</span> clientWritten = <span class="hljs-literal">false</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="log">
  <h2>
    <a href="#log" name="log" class="pilcrow"></a>
log
  </h2>
</div>
<p>this log fn is stashed on metalsmith instance to allow other plugins to
write to this debug ui.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">...args</span>
<span>accepts parameters in the same way <code>debug.log</code> does
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span> (<span class="hljs-params">...args</span>) </span>{
  <span class="hljs-keyword">let</span> clean = util.format.apply(util, args.map(stripAnsi))
  <span class="hljs-keyword">let</span> entry = <span class="hljs-regexp">/^\s*([^\s]*)\s(.*)\s([^\s]*)$/</span>.exec(clean)
  data.log.push({
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString().slice(<span class="hljs-number">11</span>, <span class="hljs-number">-1</span>),
    <span class="hljs-attr">plugin</span>: entry ? entry[<span class="hljs-number">1</span>] : <span class="hljs-string">''</span>,
    <span class="hljs-attr">message</span>: entry ? entry[<span class="hljs-number">2</span>] : clean, <span class="hljs-comment">// fallback failed regex</span>
    elapsed: entry ? entry[<span class="hljs-number">3</span>] : <span class="hljs-string">''</span>
  })
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>write to console as normal, breaks a lot of debug configuration but w/e</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  process.stdout.write(util.format.apply(util, args) + <span class="hljs-string">'\n'</span>)
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>hook <code>debug.log</code></p>

        </td>
        <td class="code highlight">
          <pre class="javascript">debug.log = log

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="patch">
  <h2>
    <a href="#patch" name="patch" class="pilcrow"></a>
patch
  </h2>
</div>
<p>patches <code>metalsmith.build</code>, when <code>build</code> is called it will wrap all plugins
with reporter.</p>
<pre><code>let metalsmith = new Metalsmith(__dirname)
patch(metalsmith)
</code></pre>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">metalsmith</span>
<span class="dox_type">object</span>
<span>instance
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">patch</span> (<span class="hljs-params">metalsmith, options</span>) </span>{
  dbg(<span class="hljs-string">'patched build fn'</span>)
  metalsmith._maskedBuild = metalsmith.build
  metalsmith.build = build
  metalsmith.log = log
  <span class="hljs-keyword">return</span> metalsmith
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="report">
  <h2>
    <a href="#report" name="report" class="pilcrow"></a>
report
  </h2>
</div>
<p>to be called as a metalsmith plugin clones current state of files &amp; metadata</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">name</span>
<span class="dox_type">String</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">report</span> (<span class="hljs-params">fnName</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">files, metalsmith</span>) </span>{
    pushData(fnName, files, metalsmith)
    writeData(files, metalsmith)
    <span class="hljs-keyword">return</span> writeClient(files, metalsmith) <span class="hljs-comment">// promise</span>
  }
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="clear">
  <h2>
    <a href="#clear" name="clear" class="pilcrow"></a>
clear
  </h2>
</div>
<p>clears data structure
useful for plugins that manage the build process like
<code>metalsmith-browser-sync</code> see issue #4</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clear</span> (<span class="hljs-params"></span>) </span>{
  data.log = []
  data.plugins = []
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="build">
  <h2>
    <a href="#build" name="build" class="pilcrow"></a>
build
  </h2>
</div>
<p>masks metalsmith's build fn. Once patched, calling build will wrap all
plugins with the debug-ui recorder, before calling the original build fn.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">...args</span>
<span>same args as metalsmith build
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">build</span> (<span class="hljs-params">callback</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p><code>masked</code> will become the new plugin array</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> masked = []
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>before running any plugins, write the client to the build dir</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  masked.push(writeClient)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>wrap all existing plugins to capture data</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>.plugins.forEach(<span class="hljs-function">(<span class="hljs-params">fn</span>) =&gt;</span> {
    masked.push(<span class="hljs-function">(<span class="hljs-params">files, metalsmith</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> fnName
      <span class="hljs-keyword">return</span> vow.resolve()
      .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> defer = vow.defer()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>wrap here to support sync, async, and promises.. like metalsmith
this also traps exceptions</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">let</span> wrapped = wrap(fn, (err) =&gt; {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>we need to try to sniff the plugin name here, because it's likely
in the stack</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>regex to match a string like <code>/metalsmith-layouts/</code></p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">let</span> regex = <span class="hljs-regexp">/\/metalsmith-((?!debug-ui).*?)\//</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>apply to a stack trace (non-standard)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">let</span> match = regex.exec(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>().stack)
          <span class="hljs-keyword">if</span> (match) fnName = match[<span class="hljs-number">1</span>]
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>if that didn't work, try for a named function</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fn.name) fnName = fn.name.replace(<span class="hljs-regexp">/bound /</span>, <span class="hljs-string">''</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>fall back to anonymous :(</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">else</span> fnName = <span class="hljs-string">'anonymous'</span>
          <span class="hljs-keyword">if</span> (err) defer.reject(err)
          <span class="hljs-keyword">else</span> defer.resolve()
        })
        wrapped(files, metalsmith)
        <span class="hljs-keyword">return</span> defer.promise()
      })
      .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> pushData(fnName, files, metalsmith))
      .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> writeData(files, metalsmith)
        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> { <span class="hljs-keyword">throw</span> err })
      })
    })
  })
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>after all plugins have run, write data to build dir</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  masked.push(writeData)

  <span class="hljs-keyword">this</span>.plugins = masked
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>run metalsmith's original build</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">this</span>._maskedBuild(callback)
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="pushdata">
  <h2>
    <a href="#pushdata" name="pushdata" class="pilcrow"></a>
pushData
  </h2>
</div>
<p>clones current files &amp; meta into store</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">files</span>
<span class="dox_type">Object</span>
<span>metalsmith files structure
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">metalsmith</span>
<span class="dox_type">Metalsmith</span>
<span>instance
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">name</span>
<span class="dox_type">String</span>
<span>descriptor for ui, usually plugin fn name
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pushData</span> (<span class="hljs-params">fnName, files, metalsmith</span>) </span>{
  data.plugins.push({
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>use fn.name to give user some idea where we're up to
name of bound function is 'bound functionName'</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    fnName,
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>convert files structure to directory tree</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    files: tree(render(files)),
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>normal metalsmith metadata</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    metadata: render(metalsmith.metadata())
  })
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="injectdata">
  <h2>
    <a href="#injectdata" name="injectdata" class="pilcrow"></a>
injectData
  </h2>
</div>
<p>writes <code>data.json</code> to metalsmith files structure</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">files</span>
<span class="dox_type">Object</span>
<span>metalsmith files structure
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeData</span> (<span class="hljs-params">files, metalsmith</span>) </span>{
  dbg(<span class="hljs-string">'writing data to build'</span>)
  <span class="hljs-keyword">let</span> defer = vow.defer()
  <span class="hljs-keyword">let</span> dataJson = {
    <span class="hljs-string">'debug-ui/data.json'</span>: {
      <span class="hljs-attr">contents</span>: Buffer.from(<span class="hljs-built_in">JSON</span>.stringify(data))
    }
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>write the history data, no need for async</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  metalsmith.write(dataJson, defer.resolve.bind(defer))
  <span class="hljs-keyword">return</span> defer.promise()
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="writeclient">
  <h2>
    <a href="#writeclient" name="writeclient" class="pilcrow"></a>
writeClient
  </h2>
</div>
<p>writes html, styles, and js to build dir</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">files</span>
<span class="dox_type">Object</span>
<span>metalsmith files structure
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">metalsmith</span>
<span class="dox_type">Metalsmith</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeClient</span> (<span class="hljs-params">files, metalsmith</span>) </span>{
  <span class="hljs-keyword">if</span> (clientWritten) <span class="hljs-keyword">return</span> vow.resolve()
  clientWritten = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">const</span> defer = vow.defer()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>scrape the client dir and inject into files</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  readdir(join(__dirname, <span class="hljs-string">'client'</span>), (err, children) =&gt; {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err)
    <span class="hljs-keyword">const</span> workers = []
    <span class="hljs-keyword">const</span> client = []
    children.forEach(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> {
      dbg(join(__dirname, <span class="hljs-string">'client'</span>, child))

      <span class="hljs-keyword">let</span> worker = readFilePromise(join(__dirname, <span class="hljs-string">'client'</span>, child))
      .then(<span class="hljs-function">(<span class="hljs-params">contents</span>) =&gt;</span> {
        dbg(join(<span class="hljs-string">'debug-ui'</span>, child))
        client[join(<span class="hljs-string">'debug-ui'</span>, child)] = { contents }
      })
      workers.push(worker)
    })
    vow.all(workers)
    .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      metalsmith.write(client, defer.resolve.bind(defer))
    })
    .catch(defer.reject.bind(defer))
  })
  <span class="hljs-keyword">return</span> defer.promise()
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="readfilepromise">
  <h2>
    <a href="#readfilepromise" name="readfilepromise" class="pilcrow"></a>
readFilePromise
  </h2>
</div>
<p>promisify readFile</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">path</span>
<span class="dox_type">String</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readFilePromise</span> (<span class="hljs-params">path</span>) </span>{
  <span class="hljs-keyword">const</span> defer = vow.defer()
  readFile(path, (err, contents) =&gt; {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> defer.reject(err)
    defer.resolve(contents)
  })
  <span class="hljs-keyword">return</span> defer.promise()
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="tree-fn">
  <h2>
    <a href="#tree-fn" name="tree-fn" class="pilcrow"></a>
tree fn
  </h2>
</div>
<p>convert files structure to directory tree</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">files</span>
<span class="dox_type">object</span>
<span>metalsmith files structure
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tree</span> (<span class="hljs-params">files</span>) </span>{
  <span class="hljs-keyword">return</span> transform(
    files,
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">result, val, key</span>) </span>{
      <span class="hljs-keyword">let</span> path = parse(key)
      <span class="hljs-keyword">if</span> (path.dir) {
        set(result, path.dir.split(sep).concat(path.base), val)
      } <span class="hljs-keyword">else</span> {
        set(result, path.base, val)
      }
    },
    {}
  )
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="render">
  <h2>
    <a href="#render" name="render" class="pilcrow"></a>
render
  </h2>
</div>
<p>Really rad fn to parse an object, convert values to something renderable,
and avoid multiple copies of the same object (recursion, cyclic references,
or just copies)</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">obj</span>
<span class="dox_type">object</span>
<span>target, files or metadata
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span> (<span class="hljs-params">obj</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>use copy so we don't mutate files</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">let</span> copy = {}
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>store seen objects so we can avoid re-printing them</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">let</span> list = [ obj ]
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>store paths so we can assign converted values to the right path</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">let</span> paths = [[<span class="hljs-string">'root'</span>]]
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> idx = <span class="hljs-number">0</span>; idx &lt; list.length; idx++) {
    <span class="hljs-keyword">let</span> item = list[idx]
    <span class="hljs-built_in">Object</span>.keys(item).forEach(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>store path of current item</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">let</span> path = paths[idx].concat([key])
      <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'contents'</span>) {
        <span class="hljs-keyword">return</span> set(copy, path, <span class="hljs-string">'...'</span>)
      }
      <span class="hljs-keyword">if</span> (Buffer.isBuffer(item[key])) {
        <span class="hljs-keyword">return</span> set(copy, path, item[key].toString())
      }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>check if this item has been rendered already</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">let</span> copyIdx = list.indexOf(item[key])
      <span class="hljs-keyword">if</span> (~copyIdx) {
        <span class="hljs-keyword">return</span> set(copy, path, <span class="hljs-string">`[Copy: <span class="hljs-subst">${paths[copyIdx].join(<span class="hljs-string">' &gt; '</span>)}</span>]`</span>)
      }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<p>store objects so we can assess them next loop</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (item[key] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Object</span>) {
        list.push(item[key])
        paths.push(path)
        <span class="hljs-keyword">return</span>
      }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<p>if none ofthe above apply, just stash the value</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      set(copy, path, item[key])
    })
  }
  <span class="hljs-keyword">return</span> copy.root
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="exports">
  <h2>
    <a href="#exports" name="exports" class="pilcrow"></a>
exports
  </h2>
</div>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> { patch, report, clear }
<span class="hljs-keyword">export</span> { patch, report, clear }

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
